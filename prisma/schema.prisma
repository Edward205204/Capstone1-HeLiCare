// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

enum CareLogType {
  meal
  exercise
  hygiene
  medication
  custom
}

enum CareTaskStatus {
  pending
  in_progress
  completed
}

enum MedicationStatus {
  scheduled
  administered
  skipped
}

enum AlertType {
  SOS
  HealthAnomaly
  OverduePayment
  LowStock
  FullRoom
}

enum NotificationType {
  Alert
  ServiceSuggestion
  PaymentReminder
  VisitReminder
}

enum ServiceType {
  base
  add_on
  special
}

enum ContractStatus {
  active
  expired
  cancelled
}

enum ContractServiceStatus {
  active
  expired
  cancelled
}

enum PaymentFrequency {
  monthly
  annually
}

enum PaymentStatus {
  paid
  overdue
  pending
}

enum SpecialCareStatus {
  suggested
  accepted
  declined
  active
  completed
}

enum ActivityStatus {
  planned
  participated
  did_not_participate
}

enum VisitStatus {
  pending
  approved
  rejected
  scheduled
  checked_in
  completed
  cancelled
}

enum InvitationStatus {
  sent
  accepted
  expired
}

enum ActivityType {
  physical_exercise
  mental_activity
  social_interaction
  meal_time
  medical_checkup
  therapy
  entertainment
  education
  religious_service
  other
}

enum ScheduleFrequency {
  daily
  weekly
  monthly
  one_time
  custom
}

enum UserRole {
  PlatformSuperAdmin
  RootAdmin
  Admin
  Staff
  Family
  Resident
}

enum StaffPosition {
  NURSE // Y tá chăm sóc trực tiếp
  CAREGIVER // Nhân viên chăm sóc, hỗ trợ sinh hoạt hằng ngày
  THERAPIST // Vật lý trị liệu / occupational therapy
  PHYSICIAN // Bác sĩ theo dõi sức khỏe
  SOCIAL_WORKER // Nhân viên xã hội, tư vấn tâm lý
  ACTIVITY_COORDINATOR // Điều phối hoạt động, giải trí
  DIETITIAN // Chuyên viên dinh dưỡng
  OTHER // Các vị trí khác
}

enum CognitiveStatus {
  NORMAL
  IMPAIRED
  SEVERE
}

enum MobilityStatus {
  INDEPENDENT
  ASSISTED
  DEPENDENT
}

enum RoomType {
  single
  double
  multi
}

enum PaymentMethod {
  // cash
  // bank_transfer
  paypal
}

enum FamilyLinkStatus {
  pending
  active
  revoked
}

enum TokenType {
  AccessToken
  RefreshToken
  EmailVerifyToken
  ForgotPasswordToken
  StaffInviteToken
  AdminInviteToken
  FamilyLinkToken
}

enum UserStatus {
  active
  inactive
}

enum InstitutionContractStatus {
  active
  cancelled
}

enum Gender {
  male
  female
}

enum ResidentAssessmentStatus {
  pending // tạo lịch hẹn
  canceled // hủy khám
  completed // khám xong
  joined // tham gia vào viện
  rejected // từ chối chung
}

enum DiseaseSeverity {
  MILD
  MODERATE
  SEVERE
}

enum DiseaseStatus {
  ACTIVE
  RECOVERED
}

enum AllergySeverity {
  MILD
  MODERATE
  SEVERE
}

model Institution {
  institution_id String                    @id @default(uuid())
  name           String
  address        Json
  contact_info   Json
  created_at     DateTime                  @default(now())
  updated_at     DateTime                  @updatedAt
  status         InstitutionContractStatus @default(active)

  users                User[]
  rooms                Room[]
  residents            Resident[]
  staffProfiles        StaffProfile[]
  visits               Visit[]
  familyResidentLinks  FamilyResidentLink[]
  residentApplications ResidentApplication[]
  activities           Activity[]
  schedules            Schedule[]
  careLogs             CareLog[]
  visitConfiguration   VisitConfiguration?
  visitTimeSlots       VisitTimeSlot[]
  visitDailyStats      VisitDailyStats[]
  servicePackages      ServicePackage[]
  contracts            Contract[]
  posts                Post[]
}

model User {
  user_id        String     @id @default(uuid())
  password       String
  email          String     @unique
  role           UserRole
  status         UserStatus @default(inactive)
  institution_id String?
  created_at     DateTime   @default(now())
  updated_at     DateTime   @updatedAt

  institution         Institution?         @relation(fields: [institution_id], references: [institution_id])
  familyProfile       FamilyProfile?
  userTokens          UserToken[]
  // residentApplication      ResidentApplication[]
  assignedResidents   Resident[]           @relation("AssignedStaff")
  resident            Resident?            @relation("ResidentUser")
  staffProfile        StaffProfile?
  familyResidentLinks FamilyResidentLink[]
  familyVisits        Visit[]              @relation("FamilyVisits")
  approvedVisits      Visit[]              @relation("VisitApprover")
  healthAssessments   HealthAssessment[]   @relation("StaffAssessments")
  staffSchedules      Schedule[]           @relation("StaffSchedules")
  staffCareLogs       CareLog[]            @relation("StaffCareLogs")
  familyContracts     Contract[]           @relation("FamilyContracts")
  posts               Post[]               @relation("PostAuthor")
  postLikes           PostLike[]           @relation("PostLikes")
  comments            Comment[]            @relation("CommentAuthor")
}

model StaffProfile {
  user_id        String        @id @unique
  avatar         String?
  institution_id String
  full_name      String
  phone          String
  position       StaffPosition
  hire_date      DateTime      @default(now())
  notes          String?
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt
  user           User          @relation(fields: [user_id], references: [user_id])
  institution    Institution   @relation(fields: [institution_id], references: [institution_id])
}

model FamilyProfile {
  profile_id String   @id @default(uuid())
  user_id    String   @unique
  full_name  String
  phone      String?
  address    String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [user_id])
}

model UserToken {
  token_id     String    @id @default(uuid())
  user_id      String
  token_string String    @unique
  token_type   TokenType
  exp          Int
  created_at   DateTime  @default(now())

  user User @relation(fields: [user_id], references: [user_id])

  @@index([user_id, token_type])
}

model Resident {
  resident_id    String   @id @default(uuid())
  user_id        String?  @unique
  institution_id String?
  room_id        String?
  full_name      String
  gender         Gender
  date_of_birth  DateTime

  // Body measurements (chỉ nhập một lần)
  height_cm Float?
  weight_kg Float?
  bmi       Float?

  notes             String?
  assigned_staff_id String?
  admission_date    DateTime?
  created_at        DateTime  @default(now())

  chronicDiseases ChronicDisease[]
  allergies       Allergy[]

  user User? @relation("ResidentUser", fields: [user_id], references: [user_id])

  institution Institution? @relation(fields: [institution_id], references: [institution_id])
  room        Room?        @relation(fields: [room_id], references: [room_id])

  assigned_staff      User?                @relation("AssignedStaff", fields: [assigned_staff_id], references: [user_id])
  familyResidentLinks FamilyResidentLink[]
  visits              Visit[]
  healthAssessments   HealthAssessment[]
  schedules           Schedule[]
  careLogs            CareLog[]
  contracts           Contract[]
  postResidents       PostResident[]       @relation("PostResidents")
}

model HealthAssessment {
  assessment_id  String @id @default(uuid())
  resident_id    String
  assessed_by_id String

  cognitive_status CognitiveStatus @default(NORMAL)
  mobility_status  MobilityStatus  @default(INDEPENDENT)
  weight_kg        Float?
  height_cm        Float?
  bmi              Float?

  temperature_c            Float?
  blood_pressure_systolic  Int?
  blood_pressure_diastolic Int?
  heart_rate               Int?
  respiratory_rate         Int?
  oxygen_saturation        Int?

  notes      String?
  created_at DateTime @default(now())

  resident    Resident @relation(fields: [resident_id], references: [resident_id])
  assessed_by User     @relation("StaffAssessments", fields: [assessed_by_id], references: [user_id])

  @@index([resident_id])
}

// Bệnh mãn tính
model ChronicDisease {
  id           String           @id @default(uuid())
  resident_id  String
  name         String // Tên bệnh
  diagnosed_at DateTime? // Ngày phát hiện
  severity     DiseaseSeverity? // Mức độ (enum)
  status       DiseaseStatus?   @default(ACTIVE) // Còn mắc / đã khỏi
  note         String? // Ghi chú thêm
  created_at   DateTime         @default(now())

  resident Resident @relation(fields: [resident_id], references: [resident_id])
}

// Dị ứng
model Allergy {
  id          String           @id @default(uuid())
  resident_id String
  substance   String // Tác nhân gây dị ứng
  reaction    String? // Phản ứng (vd: phát ban, khó thở)
  severity    AllergySeverity? // Mức độ phản ứng
  note        String?
  created_at  DateTime         @default(now())

  resident Resident @relation(fields: [resident_id], references: [resident_id])
}

model Room {
  room_id           String   @id @default(uuid())
  institution_id    String
  room_number       String
  type              RoomType
  capacity          Int
  is_available      Boolean
  current_occupancy Int
  notes             String?

  institution Institution @relation(fields: [institution_id], references: [institution_id])
  residents   Resident[]
  contracts   Contract[]
}

model FamilyResidentLink {
  link_id        String           @id @default(uuid())
  family_user_id String
  family_email   String // Email của family member để dễ query và hiển thị
  resident_id    String
  institution_id String
  status         FamilyLinkStatus @default(pending)
  created_at     DateTime         @default(now())

  family_user User        @relation(fields: [family_user_id], references: [user_id])
  resident    Resident    @relation(fields: [resident_id], references: [resident_id])
  institution Institution @relation(fields: [institution_id], references: [institution_id])

  @@unique([family_user_id, resident_id])
}

model ResidentApplication {
  application_id   String                   @id @default(uuid())
  family_user_id   String?
  resident_id      String
  institution_id   String
  appointment_date DateTime
  status           ResidentAssessmentStatus @default(pending)
  created_at       DateTime                 @default(now())
  institution      Institution              @relation(fields: [institution_id], references: [institution_id])
}

// Activity Management Models
model Activity {
  activity_id      String       @id @default(uuid())
  institution_id   String
  name             String
  description      String?
  type             ActivityType
  duration_minutes Int?
  max_participants Int?
  is_active        Boolean      @default(true)
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  institution Institution @relation(fields: [institution_id], references: [institution_id])
  schedules   Schedule[]
  careLogs    CareLog[]

  @@index([institution_id])
}

model Schedule {
  schedule_id    String  @id @default(uuid())
  activity_id    String
  institution_id String
  resident_id    String?
  staff_id       String?

  title           String
  description     String?
  start_time      DateTime
  end_time        DateTime
  frequency       ScheduleFrequency @default(one_time)
  is_recurring    Boolean           @default(false)
  recurring_until DateTime?

  status     ActivityStatus @default(planned)
  notes      String?
  created_at DateTime       @default(now())
  updated_at DateTime       @updatedAt

  activity    Activity    @relation(fields: [activity_id], references: [activity_id])
  institution Institution @relation(fields: [institution_id], references: [institution_id])
  resident    Resident?   @relation(fields: [resident_id], references: [resident_id])
  staff       User?       @relation("StaffSchedules", fields: [staff_id], references: [user_id])
  careLogs    CareLog[]

  @@index([institution_id, start_time])
  @@index([resident_id])
}

model CareLog {
  care_log_id    String  @id @default(uuid())
  resident_id    String
  staff_id       String
  activity_id    String?
  schedule_id    String?
  institution_id String

  type        CareLogType
  title       String
  description String?
  start_time  DateTime
  end_time    DateTime?
  status      CareTaskStatus @default(pending)

  // Medication specific fields
  medication_name   String?
  dosage            String?
  medication_status MedicationStatus?

  // Meal specific fields
  meal_type  String? // breakfast, lunch, dinner, snack
  food_items String?
  quantity   String?

  // Exercise specific fields
  exercise_type    String?
  duration_minutes Int?
  intensity        String? // low, medium, high

  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  resident    Resident    @relation(fields: [resident_id], references: [resident_id])
  staff       User        @relation("StaffCareLogs", fields: [staff_id], references: [user_id])
  activity    Activity?   @relation(fields: [activity_id], references: [activity_id])
  schedule    Schedule?   @relation(fields: [schedule_id], references: [schedule_id])
  institution Institution @relation(fields: [institution_id], references: [institution_id])

  @@index([resident_id, start_time])
  @@index([staff_id])
  @@index([institution_id])
  @@index([start_time])
}

model Visit {
  visit_id       String      @id @default(uuid())
  family_user_id String
  resident_id    String
  institution_id String
  visit_date     DateTime
  visit_time     String // Format: "HH:MM" (e.g., "09:00", "14:30")
  duration       Int // Duration in minutes (default 60)
  purpose        String? // Purpose of visit
  notes          String? // Additional notes
  status         VisitStatus @default(pending)
  approved_by    String? // User ID who approved (Admin/Staff)
  approved_at    DateTime?
  checked_in_at  DateTime? // Thời gian check-in
  checked_out_at DateTime? // Thời gian check-out
  qr_code_data   String? // QR code data (JWT hoặc visit_id)
  qr_expires_at  DateTime? // Thời gian hết hạn QR code
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt

  family_user User        @relation("FamilyVisits", fields: [family_user_id], references: [user_id])
  resident    Resident    @relation(fields: [resident_id], references: [resident_id])
  institution Institution @relation(fields: [institution_id], references: [institution_id])
  approver    User?       @relation("VisitApprover", fields: [approved_by], references: [user_id])
  visit_slot  VisitSlot?

  @@unique([family_user_id, visit_date, visit_time])
  @@index([visit_date, status])
  @@index([institution_id, visit_date])
  @@index([qr_code_data])
}

// Cấu hình thăm viếng cho từng institution
model VisitConfiguration {
  config_id                          String   @id @default(uuid())
  institution_id                     String   @unique
  max_visitors_per_day               Int      @default(100)
  max_visitors_per_slot              Int      @default(50)
  max_visitors_per_resident_per_slot Int      @default(3)
  advance_booking_days               Int      @default(14) // Số ngày trước có thể đặt lịch
  cancellation_hours                 Int      @default(2) // Số giờ trước có thể hủy
  created_at                         DateTime @default(now())
  updated_at                         DateTime @updatedAt

  institution Institution @relation(fields: [institution_id], references: [institution_id])
}

// Khung giờ thăm viếng
model VisitTimeSlot {
  slot_id        String   @id @default(uuid())
  institution_id String
  name           String // VD: "Sáng", "Chiều"
  start_time     String // Format: "HH:MM"
  end_time       String // Format: "HH:MM"
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  institution Institution @relation(fields: [institution_id], references: [institution_id])
  visits      VisitSlot[]

  @@index([institution_id])
}

// Liên kết Visit với TimeSlot
model VisitSlot {
  visit_slot_id String   @id @default(uuid())
  visit_id      String   @unique
  slot_id       String
  created_at    DateTime @default(now())

  visit     Visit         @relation(fields: [visit_id], references: [visit_id])
  time_slot VisitTimeSlot @relation(fields: [slot_id], references: [slot_id])
}

// Thống kê thăm viếng theo ngày
model VisitDailyStats {
  stats_id         String   @id @default(uuid())
  institution_id   String
  visit_date       DateTime
  total_visitors   Int      @default(0)
  visitors_by_slot Json // { "slot_id": count }
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  institution Institution @relation(fields: [institution_id], references: [institution_id])

  @@unique([institution_id, visit_date])
  @@index([institution_id, visit_date])
}

// Service Package & Contract Models
model ServicePackage {
  package_id     String      @id @default(uuid())
  institution_id String
  name           String
  description    String?
  type           ServiceType @default(base)

  // Pricing
  price_monthly  Float
  price_annually Float?

  // Room related
  room_type     RoomType?
  includes_room Boolean   @default(false)

  // Service details
  features      Json? // Danh sách tính năng
  max_residents Int? // Giới hạn số resident (nếu có)

  // Status
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  institution      Institution       @relation(fields: [institution_id], references: [institution_id])
  contractServices ContractService[]

  @@index([institution_id, type])
  @@index([is_active])
}

model Contract {
  contract_id    String  @id @default(uuid())
  institution_id String
  resident_id    String
  family_user_id String?

  // Contract info
  contract_number String         @unique
  status          ContractStatus @default(active)

  // Payment info
  payment_frequency PaymentFrequency
  total_amount      Float

  // Dates
  start_date  DateTime
  end_date    DateTime?
  signed_date DateTime?

  // Room assignment
  room_id String?

  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  institution      Institution       @relation(fields: [institution_id], references: [institution_id])
  resident         Resident          @relation(fields: [resident_id], references: [resident_id])
  family_user      User?             @relation("FamilyContracts", fields: [family_user_id], references: [user_id])
  room             Room?             @relation(fields: [room_id], references: [room_id])
  contractServices ContractService[]

  @@index([institution_id, status])
  @@index([resident_id])
  @@index([contract_number])
}

model ContractService {
  contract_service_id String @id @default(uuid())
  contract_id         String
  package_id          String

  status           ContractServiceStatus @default(active)
  price_at_signing Float // Giá tại thời điểm ký

  start_date DateTime
  end_date   DateTime?

  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  contract Contract       @relation(fields: [contract_id], references: [contract_id])
  package  ServicePackage @relation(fields: [package_id], references: [package_id])

  @@index([contract_id])
  @@index([package_id])
  @@index([status])
}

enum VideoEncodeStatus {
  pending
  processing
  success
  failed
}

enum MediaType {
  image
  video
  hls
}

model VideoEncode {
  video_id   String            @id @default(uuid())
  status     VideoEncodeStatus @default(pending)
  message    String?
  created_at DateTime          @default(now())
  updated_at DateTime          @updatedAt
}

enum PostVisibility {
  STAFF_ONLY
  STAFF_AND_FAMILY_OF_RESIDENTS
  PUBLIC
}

model Post {
  post_id        String @id @default(uuid())
  institution_id String
  author_id      String // User ID (Staff)

  title      String
  content    String
  image_urls String[] // Array of image URLs
  tags       String[] // Array of tags
  visibility PostVisibility @default(PUBLIC)

  likes_count Int @default(0)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  institution   Institution    @relation(fields: [institution_id], references: [institution_id])
  author        User           @relation("PostAuthor", fields: [author_id], references: [user_id])
  postResidents PostResident[]
  comments      Comment[]
  postLikes     PostLike[]

  @@index([institution_id, created_at])
  @@index([author_id])
  @@index([visibility])
}

model PostResident {
  post_resident_id String @id @default(uuid())
  post_id          String
  resident_id      String

  post     Post     @relation(fields: [post_id], references: [post_id], onDelete: Cascade)
  resident Resident @relation("PostResidents", fields: [resident_id], references: [resident_id])

  @@unique([post_id, resident_id])
  @@index([post_id])
  @@index([resident_id])
}

model PostLike {
  like_id String @id @default(uuid())
  post_id String
  user_id String

  created_at DateTime @default(now())

  post Post @relation(fields: [post_id], references: [post_id], onDelete: Cascade)
  user User @relation("PostLikes", fields: [user_id], references: [user_id])

  @@unique([post_id, user_id])
  @@index([post_id])
  @@index([user_id])
}

model Comment {
  comment_id String @id @default(uuid())
  post_id    String
  user_id    String // User ID (Staff/Family)

  content String

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  post Post @relation(fields: [post_id], references: [post_id], onDelete: Cascade)
  user User @relation("CommentAuthor", fields: [user_id], references: [user_id])

  @@index([post_id, created_at])
  @@index([user_id])
}
