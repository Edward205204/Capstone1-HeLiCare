// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

enum CareLogType {
  meal
  exercise
  hygiene
  medication
  custom
}

enum CareTaskStatus {
  pending
  in_progress
  completed
}

enum MedicationStatus {
  scheduled
  administered
  skipped
}

enum AlertType {
  SOS
  HealthAnomaly
  OverduePayment
  LowStock
  FullRoom
}

enum NotificationType {
  Alert
  ServiceSuggestion
  PaymentReminder
  VisitReminder
}

enum SpecialCareStatus {
  suggested
  accepted
  declined
  active
  completed
}

enum ActivityStatus {
  planned
  participated
  did_not_participate
}

enum VisitStatus {
  pending
  approved
  rejected
  scheduled
  checked_in
  completed
  cancelled
}

enum VisitTimeBlock {
  morning
  afternoon
  evening
}

enum InvitationStatus {
  sent
  accepted
  expired
}

enum ActivityType {
  physical_exercise
  mental_activity
  social_interaction
  meal_time
  medical_checkup
  therapy
  entertainment
  education
  religious_service
  other
}

enum ScheduleFrequency {
  daily
  weekly
  monthly
  one_time
  custom
}

enum UserRole {
  PlatformSuperAdmin
  RootAdmin
  Admin
  Staff
  Family
  Resident
}

enum StaffPosition {
  NURSE // Y tá chăm sóc trực tiếp
  CAREGIVER // Nhân viên chăm sóc, hỗ trợ sinh hoạt hằng ngày
  THERAPIST // Vật lý trị liệu / occupational therapy
  PHYSICIAN // Bác sĩ theo dõi sức khỏe
  SOCIAL_WORKER // Nhân viên xã hội, tư vấn tâm lý
  ACTIVITY_COORDINATOR // Điều phối hoạt động, giải trí
  DIETITIAN // Chuyên viên dinh dưỡng
  OTHER // Các vị trí khác
}

enum CognitiveStatus {
  NORMAL
  IMPAIRED
  SEVERE
}

enum MobilityStatus {
  INDEPENDENT
  ASSISTED
  DEPENDENT
}

enum RoomType {
  single
  double
  multi
}

enum FamilyLinkStatus {
  pending
  active
  revoked
}

enum CorrectionSourceType {
  Assessment
  CareLog
}

enum TokenType {
  AccessToken
  RefreshToken
  EmailVerifyToken
  ForgotPasswordToken
  StaffInviteToken
  AdminInviteToken
  FamilyLinkToken
}

enum UserStatus {
  active
  inactive
  pending
}

enum ResidentStatus {
  active
  inactive
  discharged
}

enum InstitutionContractStatus {
  active
  cancelled
}

enum Gender {
  male
  female
}

enum ResidentAssessmentStatus {
  pending // tạo lịch hẹn
  canceled // hủy khám
  completed // khám xong
  joined // tham gia vào viện
  rejected // từ chối chung
}

enum DiseaseSeverity {
  MILD
  MODERATE
  SEVERE
}

enum DiseaseStatus {
  ACTIVE
  RECOVERED
}

enum AllergySeverity {
  MILD
  MODERATE
  SEVERE
}

enum MealSlot {
  Breakfast
  Lunch
  Afternoon
  Dinner
}

enum DishTexture {
  Regular
  Minced
  Pureed
}

enum IngredientUnit {
  g
  ml
  pcs
}

enum DietTagType {
  LowSugar // Đái tháo đường
  LowSodium // Tăng huyết áp
  SoftTexture // Khó nuốt / Dysphagia
  HighProtein // Thiếu protein
  LowFat // Bệnh tim mạch
  HighFiber // Táo bón
  GlutenFree // Dị ứng gluten
  LactoseFree // Dị ứng lactose
  Custom // Tag tùy chỉnh
}

model Institution {
  institution_id String                    @id @default(uuid())
  name           String
  address        Json
  contact_info   Json
  created_at     DateTime                  @default(now())
  updated_at     DateTime                  @updatedAt
  status         InstitutionContractStatus @default(active)

  users                User[]
  rooms                Room[]
  residents            Resident[]
  staffProfiles        StaffProfile[]
  visits               Visit[]
  familyResidentLinks  FamilyResidentLink[]
  residentApplications ResidentApplication[]
  activities           Activity[]
  schedules            Schedule[]
  careLogs             CareLog[]
  visitConfiguration   VisitConfiguration?
  visitTimeSlots       VisitTimeSlot[]
  visitDailyStats      VisitDailyStats[]
  posts                Post[]
  feedbacks            Feedback[]
  feedbackCategories   FeedbackCategory[]
  dishes               Dish[]
  ingredients          Ingredient[]
  weeklyMenus          WeeklyMenu[]
  medications          Medication[]
  medicationCarePlans  MedicationCarePlanAssignment[]
  events               Event[]
  serviceContracts     ServiceContract[]
  staffResidents       StaffResident[]
  auditLogs            AuditLog[]
  adminSetting         AdminSetting?
  roomChangeRequests   RoomChangeRequest[]
  sosAlerts            SOSAlert[]
  incidentReports      IncidentReport[]
  dbmPaymentLogs       DBM_PaymentLog[]              @relation("DBM_PaymentLog")
}

model User {
  user_id        String     @id @default(uuid())
  password       String
  email          String     @unique
  role           UserRole
  status         UserStatus @default(inactive)
  institution_id String?
  created_at     DateTime   @default(now())
  updated_at     DateTime   @updatedAt

  institution                Institution?             @relation(fields: [institution_id], references: [institution_id])
  familyProfile              FamilyProfile?
  userTokens                 UserToken[]
  // residentApplication      ResidentApplication[]
  assignedResidents          Resident[]               @relation("AssignedStaff")
  resident                   Resident?                @relation("ResidentUser")
  staffProfile               StaffProfile?
  familyResidentLinks        FamilyResidentLink[]
  familyVisits               Visit[]                  @relation("FamilyVisits")
  approvedVisits             Visit[]                  @relation("VisitApprover")
  healthAssessments          HealthAssessment[]       @relation("StaffAssessments")
  staffSchedules             Schedule[]               @relation("StaffSchedules")
  staffCareLogs              CareLog[]                @relation("StaffCareLogs")
  posts                      Post[]                   @relation("PostAuthor")
  postLikes                  PostLike[]               @relation("PostLikes")
  comments                   Comment[]                @relation("CommentAuthor")
  healthCorrections          HealthDataCorrection[]
  familyFeedbacks            Feedback[]               @relation("FamilyFeedback")
  assignedFeedbacks          Feedback[]               @relation("AssignedFeedbackStaff")
  createdMenus               WeeklyMenu[]             @relation("MenuCreator")
  familyNotificationState    FamilyNotificationState?
  familyNotificationReads    FamilyNotificationRead[]
  paymentsMade               Payment[]
  paymentsVerified           Payment[]                @relation("PaymentVerifier")
  staffResidentLinks         StaffResident[]          @relation("StaffResidentStaff")
  auditLogs                  AuditLog[]               @relation("AuditActor")
  approvedRoomChangeRequests RoomChangeRequest[]      @relation("RoomChangeApprover")
  resolvedAlerts             SOSAlert[]               @relation("ResolvedAlerts")
  reportedIncidents          IncidentReport[]          @relation("ReportedIncidents")
  dbmUserAccount             DBM_UserAccount?          @relation("DBM_UserAccount")
  dbmPaymentLogs             DBM_PaymentLog[]          @relation("DBM_PaymentLog")
}

model StaffProfile {
  user_id        String        @id @unique
  avatar         String?
  institution_id String
  full_name      String
  phone          String
  position       StaffPosition
  hire_date      DateTime      @default(now())
  notes          String?
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt
  user           User          @relation(fields: [user_id], references: [user_id])
  institution    Institution   @relation(fields: [institution_id], references: [institution_id])
}

model FamilyProfile {
  profile_id String   @id @default(uuid())
  user_id    String   @unique
  full_name  String
  phone      String?
  address    String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [user_id])
}

model UserToken {
  token_id     String    @id @default(uuid())
  user_id      String
  token_string String    @unique
  token_type   TokenType
  exp          Int
  created_at   DateTime  @default(now())

  user User @relation(fields: [user_id], references: [user_id])

  @@index([user_id, token_type])
}

model Resident {
  resident_id    String         @id @default(uuid())
  user_id        String?        @unique
  institution_id String?
  room_id        String?
  full_name      String
  gender         Gender
  date_of_birth  DateTime
  status         ResidentStatus @default(active)

  // Body measurements (chỉ nhập một lần)
  height_cm Float?
  weight_kg Float?
  bmi       Float?

  notes             String?
  assigned_staff_id String?
  admission_date    DateTime?
  created_at        DateTime  @default(now())

  chronicDiseases ChronicDisease[]
  allergies       Allergy[]

  user User? @relation("ResidentUser", fields: [user_id], references: [user_id])

  institution        Institution?        @relation(fields: [institution_id], references: [institution_id])
  room               Room?               @relation(fields: [room_id], references: [room_id])
  roomChangeRequests RoomChangeRequest[]

  assigned_staff      User?                @relation("AssignedStaff", fields: [assigned_staff_id], references: [user_id])
  familyResidentLinks FamilyResidentLink[]
  visits              Visit[]
  healthAssessments   HealthAssessment[]
  schedules           Schedule[]
  careLogs            CareLog[]
  postResidents       PostResident[]       @relation("PostResidents")
  dietTags            ResidentDietTag[]
  feedbacks           Feedback[]
  serviceContract     ServiceContract?
  staffResidentLinks  StaffResident[]      @relation("ResidentStaffLinks")
  sosAlerts           SOSAlert[]
  incidentReports     IncidentReport[]
}

model StaffResident {
  staff_resident_id String   @id @default(uuid())
  staff_id          String
  resident_id       String
  institution_id    String
  role              String?
  created_at        DateTime @default(now())

  staff       User        @relation("StaffResidentStaff", fields: [staff_id], references: [user_id])
  resident    Resident    @relation("ResidentStaffLinks", fields: [resident_id], references: [resident_id])
  institution Institution @relation(fields: [institution_id], references: [institution_id])

  @@unique([staff_id, resident_id])
  @@index([institution_id])
}

model AuditLog {
  audit_id       String   @id @default(uuid())
  institution_id String
  actor_id       String?
  target_type    String
  target_id      String?
  action         String
  metadata       Json?
  created_at     DateTime @default(now())

  institution Institution @relation(fields: [institution_id], references: [institution_id])
  actor       User?       @relation("AuditActor", fields: [actor_id], references: [user_id])

  @@index([institution_id, created_at])
  @@index([target_type, target_id])
}

model AdminSetting {
  institution_id  String   @id
  email_templates Json?
  toggles         Json?
  updated_at      DateTime @updatedAt

  institution Institution @relation(fields: [institution_id], references: [institution_id])
}

model HealthAssessment {
  assessment_id  String @id @default(uuid())
  resident_id    String
  assessed_by_id String

  cognitive_status CognitiveStatus @default(NORMAL)
  mobility_status  MobilityStatus  @default(INDEPENDENT)
  weight_kg        Float?
  height_cm        Float?
  bmi              Float?

  temperature_c            Float?
  blood_pressure_systolic  Int?
  blood_pressure_diastolic Int?
  heart_rate               Int?
  respiratory_rate         Int?
  oxygen_saturation        Int?

  notes             String?
  measured_at       DateTime @default(now())
  measurement_shift String?
  measurement_by    String?
  created_at        DateTime @default(now())

  resident    Resident @relation(fields: [resident_id], references: [resident_id])
  assessed_by User     @relation("StaffAssessments", fields: [assessed_by_id], references: [user_id])

  @@index([resident_id])
  @@index([resident_id, measured_at])
}

// Bệnh mãn tính
model ChronicDisease {
  id           String           @id @default(uuid())
  resident_id  String
  name         String // Tên bệnh
  diagnosed_at DateTime? // Ngày phát hiện
  severity     DiseaseSeverity? // Mức độ (enum)
  status       DiseaseStatus?   @default(ACTIVE) // Còn mắc / đã khỏi
  note         String? // Ghi chú thêm
  created_at   DateTime         @default(now())

  resident Resident @relation(fields: [resident_id], references: [resident_id])
}

// Dị ứng
model Allergy {
  id          String           @id @default(uuid())
  resident_id String
  substance   String // Tác nhân gây dị ứng
  reaction    String? // Phản ứng (vd: phát ban, khó thở)
  severity    AllergySeverity? // Mức độ phản ứng
  note        String?
  created_at  DateTime         @default(now())

  resident Resident @relation(fields: [resident_id], references: [resident_id])
}

model Room {
  room_id           String   @id @default(uuid())
  institution_id    String
  room_number       String
  type              RoomType
  capacity          Int
  is_available      Boolean
  current_occupancy Int
  notes             String?

  institution                 Institution         @relation(fields: [institution_id], references: [institution_id])
  residents                   Resident[]
  currentRoomChangeRequests   RoomChangeRequest[] @relation("CurrentRoomRequests")
  requestedRoomChangeRequests RoomChangeRequest[] @relation("RequestedRoomRequests")
}

model FamilyResidentLink {
  link_id        String           @id @default(uuid())
  family_user_id String
  family_email   String // Email của family member để dễ query và hiển thị
  resident_id    String
  institution_id String
  status         FamilyLinkStatus @default(pending)
  created_at     DateTime         @default(now())

  family_user User        @relation(fields: [family_user_id], references: [user_id])
  resident    Resident    @relation(fields: [resident_id], references: [resident_id])
  institution Institution @relation(fields: [institution_id], references: [institution_id])

  @@unique([family_user_id, resident_id])
}

model ResidentApplication {
  application_id   String                   @id @default(uuid())
  family_user_id   String?
  resident_id      String
  institution_id   String
  appointment_date DateTime
  status           ResidentAssessmentStatus @default(pending)
  created_at       DateTime                 @default(now())
  institution      Institution              @relation(fields: [institution_id], references: [institution_id])
}

// Activity Management Models
model Activity {
  activity_id      String       @id @default(uuid())
  institution_id   String
  name             String
  description      String?
  type             ActivityType
  duration_minutes Int?
  max_participants Int?
  is_active        Boolean      @default(true)
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  institution Institution @relation(fields: [institution_id], references: [institution_id])
  schedules   Schedule[]
  careLogs    CareLog[]

  @@index([institution_id])
}

model Schedule {
  schedule_id    String  @id @default(uuid())
  activity_id    String
  institution_id String
  resident_id    String?
  staff_id       String?

  title           String
  description     String?
  start_time      DateTime
  end_time        DateTime
  frequency       ScheduleFrequency @default(one_time)
  is_recurring    Boolean           @default(false)
  recurring_until DateTime?

  status     ActivityStatus @default(planned)
  notes      String?
  created_at DateTime       @default(now())
  updated_at DateTime       @updatedAt

  activity    Activity    @relation(fields: [activity_id], references: [activity_id])
  institution Institution @relation(fields: [institution_id], references: [institution_id])
  resident    Resident?   @relation(fields: [resident_id], references: [resident_id])
  staff       User?       @relation("StaffSchedules", fields: [staff_id], references: [user_id])
  careLogs    CareLog[]

  @@index([institution_id, start_time])
  @@index([resident_id])
}

model CareLog {
  care_log_id    String  @id @default(uuid())
  resident_id    String
  staff_id       String
  activity_id    String?
  schedule_id    String?
  institution_id String

  type        CareLogType
  title       String
  description String?
  start_time  DateTime
  end_time    DateTime?
  status      CareTaskStatus @default(pending)

  // Medication specific fields
  medication_name   String?
  dosage            String?
  medication_status MedicationStatus?

  // Meal specific fields
  meal_type  String? // breakfast, lunch, dinner, snack
  food_items String?
  quantity   String?

  // Exercise specific fields
  exercise_type    String?
  duration_minutes Int?
  intensity        String? // low, medium, high

  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  resident    Resident    @relation(fields: [resident_id], references: [resident_id])
  staff       User        @relation("StaffCareLogs", fields: [staff_id], references: [user_id])
  activity    Activity?   @relation(fields: [activity_id], references: [activity_id])
  schedule    Schedule?   @relation(fields: [schedule_id], references: [schedule_id])
  institution Institution @relation(fields: [institution_id], references: [institution_id])

  @@index([resident_id, start_time])
  @@index([staff_id])
  @@index([institution_id])
  @@index([start_time])
}

model Visit {
  visit_id       String          @id @default(uuid())
  family_user_id String
  resident_id    String
  institution_id String
  visit_date     DateTime
  visit_time     String? // Format: "HH:MM" (e.g., "09:00", "14:30") - deprecated, use time_block instead
  time_block     VisitTimeBlock? // Time block: morning, afternoon, evening
  duration       Int // Duration in minutes (default 60)
  purpose        String? // Purpose of visit
  notes          String? // Additional notes
  status         VisitStatus     @default(pending)
  approved_by    String? // User ID who approved (Admin/Staff)
  approved_at    DateTime?
  checked_in_at  DateTime? // Thời gian check-in
  checked_out_at DateTime? // Thời gian check-out
  qr_code_data   String? // QR code data (JWT hoặc visit_id)
  qr_expires_at  DateTime? // Thời gian hết hạn QR code
  created_at     DateTime        @default(now())
  updated_at     DateTime        @updatedAt

  family_user User        @relation("FamilyVisits", fields: [family_user_id], references: [user_id])
  resident    Resident    @relation(fields: [resident_id], references: [resident_id])
  institution Institution @relation(fields: [institution_id], references: [institution_id])
  approver    User?       @relation("VisitApprover", fields: [approved_by], references: [user_id])
  visit_slot  VisitSlot?

  @@unique([family_user_id, resident_id, visit_date, visit_time])
  @@unique([family_user_id, resident_id, visit_date, time_block])
  @@index([visit_date, status])
  @@index([institution_id, visit_date])
  @@index([institution_id, visit_date, time_block])
  @@index([qr_code_data])
}

// Cấu hình thăm viếng cho từng institution
model VisitConfiguration {
  config_id                          String   @id @default(uuid())
  institution_id                     String   @unique
  max_visitors_per_day               Int      @default(100)
  max_visitors_per_slot              Int      @default(50)
  max_visitors_per_resident_per_slot Int      @default(3)
  max_visitors_per_time_block        Int      @default(20) // Max visitors per time block (morning/afternoon/evening)
  advance_booking_days               Int      @default(14) // Số ngày trước có thể đặt lịch
  cancellation_hours                 Int      @default(2) // Số giờ trước có thể hủy
  created_at                         DateTime @default(now())
  updated_at                         DateTime @updatedAt

  institution Institution @relation(fields: [institution_id], references: [institution_id])
}

// Khung giờ thăm viếng
model VisitTimeSlot {
  slot_id        String   @id @default(uuid())
  institution_id String
  name           String // VD: "Sáng", "Chiều"
  start_time     String // Format: "HH:MM"
  end_time       String // Format: "HH:MM"
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  institution Institution @relation(fields: [institution_id], references: [institution_id])
  visits      VisitSlot[]

  @@index([institution_id])
}

// Liên kết Visit với TimeSlot
model VisitSlot {
  visit_slot_id String   @id @default(uuid())
  visit_id      String   @unique
  slot_id       String
  created_at    DateTime @default(now())

  visit     Visit         @relation(fields: [visit_id], references: [visit_id])
  time_slot VisitTimeSlot @relation(fields: [slot_id], references: [slot_id])
}

// Thống kê thăm viếng theo ngày
model VisitDailyStats {
  stats_id         String   @id @default(uuid())
  institution_id   String
  visit_date       DateTime
  total_visitors   Int      @default(0)
  visitors_by_slot Json // { "slot_id": count }
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  institution Institution @relation(fields: [institution_id], references: [institution_id])

  @@unique([institution_id, visit_date])
  @@index([institution_id, visit_date])
}

model HealthDataCorrection {
  correction_id   String               @id @default(uuid())
  source_type     CorrectionSourceType
  source_id       String
  field           String
  previous_value  String?
  new_value       String?
  reason          String?
  corrected_by_id String
  created_at      DateTime             @default(now())

  corrected_by User @relation(fields: [corrected_by_id], references: [user_id])

  @@index([source_type, source_id])
}

enum VideoEncodeStatus {
  pending
  processing
  success
  failed
}

enum MediaType {
  image
  video
  hls
}

model VideoEncode {
  video_id   String            @id @default(uuid())
  status     VideoEncodeStatus @default(pending)
  message    String?
  created_at DateTime          @default(now())
  updated_at DateTime          @updatedAt
}

enum PostVisibility {
  STAFF_ONLY
  STAFF_AND_FAMILY_OF_RESIDENTS
  PUBLIC
}

model Post {
  post_id        String @id @default(uuid())
  institution_id String
  author_id      String // User ID (Staff)

  title      String
  content    String
  image_urls String[] // Array of image URLs
  tags       String[] // Array of tags
  visibility PostVisibility @default(PUBLIC)

  likes_count Int @default(0)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  institution   Institution    @relation(fields: [institution_id], references: [institution_id])
  author        User           @relation("PostAuthor", fields: [author_id], references: [user_id])
  postResidents PostResident[]
  comments      Comment[]
  postLikes     PostLike[]

  @@index([institution_id, created_at])
  @@index([author_id])
  @@index([visibility])
}

model PostResident {
  post_resident_id String @id @default(uuid())
  post_id          String
  resident_id      String

  post     Post     @relation(fields: [post_id], references: [post_id], onDelete: Cascade)
  resident Resident @relation("PostResidents", fields: [resident_id], references: [resident_id])

  @@unique([post_id, resident_id])
  @@index([post_id])
  @@index([resident_id])
}

model PostLike {
  like_id String @id @default(uuid())
  post_id String
  user_id String

  created_at DateTime @default(now())

  post Post @relation(fields: [post_id], references: [post_id], onDelete: Cascade)
  user User @relation("PostLikes", fields: [user_id], references: [user_id])

  @@unique([post_id, user_id])
  @@index([post_id])
  @@index([user_id])
}

model Comment {
  comment_id String @id @default(uuid())
  post_id    String
  user_id    String // User ID (Staff/Family)

  content String

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  post Post @relation(fields: [post_id], references: [post_id], onDelete: Cascade)
  user User @relation("CommentAuthor", fields: [user_id], references: [user_id])

  @@index([post_id, created_at])
  @@index([user_id])
}

enum FeedbackStatus {
  pending
  in_progress
  resolved
}

model FeedbackCategory {
  category_id    String   @id @default(uuid())
  institution_id String
  name           String
  description    String?
  metadata       Json? // e.g., { requiredFields: [], attachmentsRequired: boolean, urgency: string, contactMethod: string, types: string[] }
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  institution Institution @relation(fields: [institution_id], references: [institution_id])
  feedbacks   Feedback[]

  @@index([institution_id])
  @@index([institution_id, is_active])
}

model Feedback {
  feedback_id       String         @id @default(uuid())
  family_user_id    String
  resident_id       String?
  institution_id    String
  category_id       String
  type              String? // Dynamic subtype per category
  message           String
  attachments       String[] // Array of attachment URLs
  status            FeedbackStatus @default(pending)
  staff_notes       String?
  assigned_staff_id String?
  created_at        DateTime       @default(now())
  updated_at        DateTime       @updatedAt
  resolved_at       DateTime?

  family_user    User             @relation("FamilyFeedback", fields: [family_user_id], references: [user_id])
  resident       Resident?        @relation(fields: [resident_id], references: [resident_id])
  institution    Institution      @relation(fields: [institution_id], references: [institution_id])
  category       FeedbackCategory @relation(fields: [category_id], references: [category_id])
  assigned_staff User?            @relation("AssignedFeedbackStaff", fields: [assigned_staff_id], references: [user_id])

  @@index([family_user_id, created_at])
  @@index([institution_id, status])
  @@index([institution_id, category_id])
  @@index([resident_id])
  @@index([status])
  @@index([category_id])
}

enum RoomChangeRequestStatus {
  pending
  approved
  rejected
  completed
}

model RoomChangeRequest {
  request_id          String                  @id @default(uuid())
  resident_id         String
  institution_id      String
  requested_by        String // user_id của người yêu cầu (family_user_id hoặc resident user_id)
  requested_by_role   UserRole // Family hoặc Resident
  current_room_id     String? // Phòng hiện tại
  requested_room_id   String // Phòng muốn chuyển đến
  requested_room_type RoomType // Loại phòng yêu cầu (single, double, multi)
  status              RoomChangeRequestStatus @default(pending)
  reason              String? // Lý do yêu cầu đổi phòng
  approved_by         String? // user_id của staff/admin đã duyệt
  approved_at         DateTime?
  rejected_at         DateTime?
  completed_at        DateTime? // Thời gian hoàn thành đổi phòng
  notes               String? // Ghi chú từ staff
  created_at          DateTime                @default(now())
  updated_at          DateTime                @updatedAt

  resident       Resident    @relation(fields: [resident_id], references: [resident_id])
  institution    Institution @relation(fields: [institution_id], references: [institution_id])
  current_room   Room?       @relation("CurrentRoomRequests", fields: [current_room_id], references: [room_id])
  requested_room Room        @relation("RequestedRoomRequests", fields: [requested_room_id], references: [room_id])
  approver       User?       @relation("RoomChangeApprover", fields: [approved_by], references: [user_id])

  @@index([resident_id])
  @@index([institution_id])
  @@index([status])
  @@index([requested_by])
  @@index([created_at])
}

// Trạng thái thông báo của family user (mốc đã xem gần nhất)
model FamilyNotificationState {
  user_id      String   @id
  last_seen_at DateTime @default(now())
  updated_at   DateTime @updatedAt

  user User @relation(fields: [user_id], references: [user_id])

  @@index([last_seen_at])
}

// Lưu notification đã đọc theo từng notification_id (fb:..., post:..., health:...)
model FamilyNotificationRead {
  read_id         String   @id @default(uuid())
  user_id         String
  notification_id String
  created_at      DateTime @default(now())

  user User @relation(fields: [user_id], references: [user_id])

  @@unique([user_id, notification_id])
  @@index([user_id])
}

// Menu Planner Models
model Dish {
  dish_id           String      @id @default(uuid())
  institution_id    String
  name              String
  calories_per_100g Float
  texture           DishTexture @default(Regular)
  sugar_adjustable  Boolean     @default(false)
  sodium_level      Float? // mg per 100g
  dietary_flags     Json? // Array of dietary flags: ["diabetic", "low_sodium", "gluten_free", etc.]
  is_blendable      Boolean     @default(false) // Can be blended to create variants
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt

  institution     Institution      @relation(fields: [institution_id], references: [institution_id])
  dishIngredients DishIngredient[]
  weeklyMenuItems WeeklyMenuItem[]

  @@index([institution_id])
  @@index([texture])
}

model Ingredient {
  ingredient_id     String         @id @default(uuid())
  institution_id    String
  name              String
  unit              IngredientUnit
  calories_per_100g Float
  protein_per_100g  Float          @default(0)
  fat_per_100g      Float          @default(0)
  carbs_per_100g    Float          @default(0)
  fiber_per_100g    Float?         @default(0)
  sodium_per_100g   Float?         @default(0)
  created_at        DateTime       @default(now())
  updated_at        DateTime       @updatedAt

  institution     Institution      @relation(fields: [institution_id], references: [institution_id])
  dishIngredients DishIngredient[]

  @@index([institution_id])
}

model DishIngredient {
  dish_ingredient_id String @id @default(uuid())
  dish_id            String
  ingredient_id      String
  amount             Float // Amount in the unit of the ingredient (g/ml/pcs)

  dish       Dish       @relation(fields: [dish_id], references: [dish_id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredient_id], references: [ingredient_id], onDelete: Cascade)

  @@unique([dish_id, ingredient_id])
  @@index([dish_id])
  @@index([ingredient_id])
}

model WeeklyMenu {
  menu_id         String   @id @default(uuid())
  institution_id  String
  week_start_date DateTime // Monday of the week
  week_end_date   DateTime // Sunday of the week
  created_by_id   String
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  institution Institution      @relation(fields: [institution_id], references: [institution_id])
  created_by  User             @relation("MenuCreator", fields: [created_by_id], references: [user_id])
  menuItems   WeeklyMenuItem[]

  @@unique([institution_id, week_start_date])
  @@index([institution_id, week_start_date])
}

model WeeklyMenuItem {
  menu_item_id    String       @id @default(uuid())
  menu_id         String
  dish_id         String
  meal_slot       MealSlot
  day_of_week     Int // 0 = Monday, 6 = Sunday
  servings        Int // Number of servings
  texture_variant DishTexture? // Override texture for this specific menu item
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  menu WeeklyMenu @relation(fields: [menu_id], references: [menu_id], onDelete: Cascade)
  dish Dish       @relation(fields: [dish_id], references: [dish_id])

  @@index([menu_id, day_of_week, meal_slot])
  @@index([dish_id])
}

// Diet Tags for Residents - Auto-assigned based on Vital Signs & Medical Records
model ResidentDietTag {
  tag_id      String      @id @default(uuid())
  resident_id String
  tag_type    DietTagType
  tag_name    String // Human-readable name (e.g., "Low Sugar", "Soft Texture")
  source_type String // "vital_sign", "medical_record", "manual_override"
  source_id   String? // ID of the source (assessment_id, etc.)
  assigned_at DateTime    @default(now())
  expires_at  DateTime? // Optional expiration (null = permanent until removed)
  is_active   Boolean     @default(true)
  notes       String?

  resident Resident @relation(fields: [resident_id], references: [resident_id], onDelete: Cascade)

  @@unique([resident_id, tag_type])
  @@index([resident_id, is_active])
  @@index([tag_type])
  @@index([is_active])
}

// Medication Management Models
enum MedicationForm {
  tablet
  syrup
  injection
  capsule
  liquid
  cream
  other
}

enum MedicationTiming {
  before_meal
  after_meal
  with_meal
  any_time
}

model Medication {
  medication_id  String           @id @default(uuid())
  institution_id String
  name           String
  dosage         String // e.g., "100mg", "5ml"
  form           MedicationForm   @default(tablet)
  frequency      String // e.g., "Twice daily", "Once daily", "Three times daily"
  timing         MedicationTiming @default(any_time)
  instructions   String? // Additional instructions
  is_active      Boolean          @default(true)
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt

  institution Institution                    @relation(fields: [institution_id], references: [institution_id])
  assignments MedicationCarePlanAssignment[]

  @@index([institution_id])
  @@index([is_active])
}

enum TimeSlot {
  morning
  noon
  afternoon
  evening
}

model MedicationCarePlanAssignment {
  assignment_id  String @id @default(uuid())
  medication_id  String
  institution_id String

  // Assignment targets
  resident_ids String[] // Array of resident UUIDs
  room_ids     String[] // Array of room UUIDs
  staff_ids    String[] // Array of staff UUIDs

  // Schedule
  start_date DateTime
  end_date   DateTime?
  time_slot  TimeSlot? // Optional time slot: morning, noon, afternoon, evening

  // Status
  is_active Boolean @default(true)

  // Metadata
  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  medication  Medication  @relation(fields: [medication_id], references: [medication_id], onDelete: Cascade)
  institution Institution @relation(fields: [institution_id], references: [institution_id])

  @@index([medication_id])
  @@index([institution_id])
  @@index([is_active])
  @@index([start_date, end_date])
  @@index([time_slot])
}

enum EventType {
  Care
  Entertainment
  Other
}

enum EventStatus {
  Upcoming
  Cancelled
  Ongoing
  Ended
}

enum CareSubType {
  VitalCheck
  Therapy
  MedicationAdmin
  Hygiene
  Meal
  Other
}

enum EventFrequency {
  Daily
  Weekly
  Monthly
  OneTime
}

model Event {
  event_id           String      @id @default(uuid())
  institution_id     String
  name               String
  type               EventType
  status             EventStatus @default(Upcoming)
  start_time         DateTime
  end_time           DateTime
  location           String // Default to institution name
  room_ids           String[] // Optional for special events
  care_configuration Json? // { subType, frequency } - only for Care events
  created_at         DateTime    @default(now())
  updated_at         DateTime    @updatedAt

  institution Institution @relation(fields: [institution_id], references: [institution_id])

  @@index([institution_id])
  @@index([institution_id, start_time])
  @@index([status])
  @@index([type])
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum PaymentMethod {
  CASH
  TRANSFER
  VNPAY // VNPay online payment gateway
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model ServiceContract {
  contract_id    String @id @default(uuid())
  resident_id    String @unique // Mỗi cụ chỉ có 1 hợp đồng active tại 1 thời điểm
  institution_id String

  billing_cycle BillingCycle @default(MONTHLY) // Trả theo Tháng hay Năm
  amount        Float // Giá tiền của gói này

  start_date DateTime @default(now())

  // Quan trọng: Ngày cần thanh toán tiếp theo. 
  // Ví dụ: Đã trả tháng 10, next_billing_date sẽ là 01/11.
  // Logic Frontend: Nếu today >= next_billing_date => Hiện nút "Thanh toán ngay"
  next_billing_date DateTime

  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  resident    Resident    @relation(fields: [resident_id], references: [resident_id])
  institution Institution @relation(fields: [institution_id], references: [institution_id])
  payments    Payment[] // Lịch sử các lần gia hạn hợp đồng này

  @@index([institution_id])
}

model Payment {
  payment_id  String  @id @default(uuid())
  contract_id String
  payer_id    String?

  amount         Float
  payment_method PaymentMethod @default(TRANSFER)
  status         PaymentStatus @default(PENDING)

  transaction_ref String? // Mã tham chiếu giao dịch (mã chuyển khoản hoặc mã VNPay)

  // Cho chuyển khoản upload ảnh chứng từ
  proof_image_url String? // URL ảnh chứng từ chuyển khoản

  // Cho VNPay
  vnpay_transaction_no String? // Mã giao dịch VNPay (vnp_TransactionNo)
  vnpay_order_id       String? // Order ID gửi cho VNPay (vnp_TxnRef)
  vnpay_response_code  String? // Mã phản hồi từ VNPay (vnp_ResponseCode)
  vnpay_bank_code      String? // Mã ngân hàng thanh toán (vnp_BankCode)

  // Metadata
  notes          String? // Ghi chú thêm
  verified_by_id String? // Admin xác nhận (cho manual verification)
  verified_at    DateTime? // Thời gian xác nhận

  period_start DateTime
  period_end   DateTime

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  contract    ServiceContract @relation(fields: [contract_id], references: [contract_id])
  payer       User?           @relation(fields: [payer_id], references: [user_id])
  verified_by User?           @relation("PaymentVerifier", fields: [verified_by_id], references: [user_id])
  
  // Mock database relations
  dbmTransactionHistory DBM_TransactionHistory? @relation("DBM_TransactionHistory")
  dbmPaymentLog          DBM_PaymentLog?        @relation("DBM_PaymentLog")

  @@index([contract_id])
  @@index([transaction_ref])
  @@index([vnpay_order_id])
  @@index([status])
  @@index([payer_id])
}

enum SOSAlertType {
  fall
  abnormal_vitals
  emergency_button
}

enum SOSAlertStatus {
  pending
  acknowledged
  in_progress
  resolved
  escalated
}

enum SOSAlertSeverity {
  high
  medium
  low
}

model SOSAlert {
  alert_id      String          @id @default(uuid())
  resident_id   String
  institution_id String
  type          SOSAlertType
  severity      SOSAlertSeverity
  status        SOSAlertStatus  @default(pending)
  
  // Vital signs snapshot (for abnormal_vitals type)
  vital_snapshot Json? // { bp_systolic, bp_diastolic, heart_rate, temperature, etc. }
  
  // Timer countdown (in seconds) - calculated from created_at
  timer_seconds Int? // Default 60 seconds
  
  // Metadata
  notes         String?
  resolved_by_id String? // Staff who resolved
  resolved_at    DateTime?
  escalated_at   DateTime?
  
  created_at    DateTime        @default(now())
  updated_at    DateTime        @updatedAt

  resident      Resident        @relation(fields: [resident_id], references: [resident_id])
  institution   Institution     @relation(fields: [institution_id], references: [institution_id])
  resolved_by   User?           @relation("ResolvedAlerts", fields: [resolved_by_id], references: [user_id])

  @@index([institution_id, status])
  @@index([resident_id])
  @@index([type])
  @@index([created_at])
  @@index([status, created_at])
}

enum IncidentType {
  fall
  health_event
  behavioral
  environmental_hazard
}

model IncidentReport {
  report_id       String        @id @default(uuid())
  resident_id     String
  institution_id  String
  reported_by_id  String // Staff who reported
  
  incident_type   IncidentType
  root_cause      String?
  actions_taken   String
  outcome         String
  occurred_at     DateTime // Combined date and time
  
  staff_on_duty   String? // Staff name (can be different from reported_by)
  images          String[] // Array of image URLs
  
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  resident        Resident      @relation(fields: [resident_id], references: [resident_id])
  institution     Institution   @relation(fields: [institution_id], references: [institution_id])
  reported_by     User          @relation("ReportedIncidents", fields: [reported_by_id], references: [user_id])

  @@index([institution_id, created_at])
  @@index([resident_id])
  @@index([incident_type])
  @@index([occurred_at])
}

// ========== MOCK DATABASE TABLES (DBM) - For VNPay Mock Payment System ==========
// Các table này dùng để mock hệ thống thanh toán VNPay với tài khoản ngân hàng ảo
// Mỗi user sẽ có 100 triệu VND trong tài khoản mặc định

// Tài khoản ngân hàng mock của user (Family/Resident)
model DBM_UserAccount {
  account_id     String   @id @default(uuid())
  user_id        String   @unique // Link với User table
  account_number String   @unique @default(uuid()) // Số tài khoản ảo
  balance        Float    @default(100000000) // Số dư mặc định: 100 triệu VND
  currency       String   @default("VND")
  status         String   @default("active") // active, frozen, closed
  bank_name      String   @default("NCB") // Ngân hàng mock
  
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  
  user           User     @relation("DBM_UserAccount", fields: [user_id], references: [user_id])
  transactions   DBM_TransactionHistory[]
  paymentLogs    DBM_PaymentLog[] @relation("DBM_PaymentLog")
  
  @@index([user_id])
  @@index([account_number])
  @@index([status])
}

// Lịch sử giao dịch mock (tất cả các giao dịch trừ/cộng tiền)
model DBM_TransactionHistory {
  transaction_id   String   @id @default(uuid())
  account_id       String
  payment_id       String?  @unique // Link với Payment table nếu có
  
  transaction_type String  // debit (trừ tiền), credit (cộng tiền), refund (hoàn tiền)
  amount           Float    // Số tiền giao dịch
  balance_before   Float    // Số dư trước giao dịch
  balance_after    Float    // Số dư sau giao dịch
  
  description      String   // Mô tả giao dịch
  reference_code   String?  // Mã tham chiếu (vnpay_order_id, transaction_ref, etc.)
  
  status           String   @default("completed") // completed, failed, pending, cancelled
  
  created_at       DateTime @default(now())
  
  account          DBM_UserAccount @relation(fields: [account_id], references: [account_id])
  payment          Payment?        @relation("DBM_TransactionHistory", fields: [payment_id], references: [payment_id])
  paymentLog       DBM_PaymentLog? @relation("DBM_PaymentLog")
  
  @@index([account_id])
  @@index([payment_id])
  @@index([transaction_type])
  @@index([status])
  @@index([created_at])
  @@index([reference_code])
}

// Log thanh toán của viện (để làm dashboard và báo cáo)
model DBM_PaymentLog {
  log_id          String   @id @default(uuid())
  institution_id  String
  payment_id      String   @unique
  
  // Thông tin thanh toán
  amount          Float
  payment_method  String   // VNPAY, TRANSFER, etc.
  status          String   // SUCCESS, FAILED, PENDING, REFUNDED
  
  // Thông tin người thanh toán
  payer_id        String?  // User ID của người thanh toán
  payer_type      String?  // family, resident
  payer_name      String?  // Tên người thanh toán
  
  // Thông tin cư dân
  resident_id     String?
  resident_name   String?
  
  // Thông tin hợp đồng
  contract_id     String?
  
  // Thông tin giao dịch VNPay
  vnpay_order_id       String?
  vnpay_transaction_no String?
  vnpay_response_code  String?
  vnpay_bank_code      String?
  
  // Thông tin tài khoản mock
  account_id           String?  // Link với DBM_UserAccount
  transaction_id       String?  @unique // Link với DBM_TransactionHistory
  
  // Metadata
  period_start    DateTime?
  period_end      DateTime?
  notes           String?
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  institution     Institution @relation("DBM_PaymentLog", fields: [institution_id], references: [institution_id])
  payment         Payment     @relation("DBM_PaymentLog", fields: [payment_id], references: [payment_id])
  payer           User?       @relation("DBM_PaymentLog", fields: [payer_id], references: [user_id])
  account         DBM_UserAccount? @relation("DBM_PaymentLog", fields: [account_id], references: [account_id])
  transaction     DBM_TransactionHistory? @relation("DBM_PaymentLog", fields: [transaction_id], references: [transaction_id])
  
  @@index([institution_id])
  @@index([payment_id])
  @@index([payer_id])
  @@index([resident_id])
  @@index([contract_id])
  @@index([status])
  @@index([payment_method])
  @@index([created_at])
  @@index([vnpay_order_id])
}
